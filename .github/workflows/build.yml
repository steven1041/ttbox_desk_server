name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        cache: true
    
    - name: Build release
      run: cargo build --release
    
    - name: Create release package
      run: |
        mkdir -p release
        cp target/release/ttbox_salvo release/
        cp config.toml release/
        cp .env.example release/ 2>/dev/null || echo "# Environment variables" > release/.env
        cp -r assets release/
        cp -r views release/
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > release/deploy.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ å¼€å§‹éƒ¨ç½²..."
        
        # æ£€æŸ¥æ˜¯å¦ä¸º root
        if [ "$EUID" -ne 0 ]; then 
            echo "è¯·ä½¿ç”¨ sudo è¿è¡Œæ­¤è„šæœ¬"
            exit 1
        fi
        
        # åˆ›å»ºç”¨æˆ·
        if ! id -u ttbox &>/dev/null; then
            echo "ðŸ‘¤ åˆ›å»º ttbox ç”¨æˆ·..."
            useradd -m -r -s /bin/bash ttbox
        fi
        
        # åˆ›å»ºç›®å½•
        echo "ðŸ“ åˆ›å»ºç›®å½•..."
        mkdir -p /opt/ttbox
        mkdir -p /var/log/ttbox
        mkdir -p /etc/ttbox
        
        # å¤åˆ¶æ–‡ä»¶
        echo "ðŸ“‹ å¤åˆ¶æ–‡ä»¶..."
        cp ttbox_salvo /opt/ttbox/
        chmod +x /opt/ttbox/ttbox_salvo
        chown ttbox:ttbox /opt/ttbox/ttbox_salvo
        
        cp -r assets /opt/ttbox/
        cp -r views /opt/ttbox/
        chown -R ttbox:ttbox /opt/ttbox/assets
        chown -R ttbox:ttbox /opt/ttbox/views
        
        # é…ç½®æ–‡ä»¶
        if [ ! -f /etc/ttbox/config.toml ]; then
            cp config.toml /etc/ttbox/
            echo "âš™ï¸  è¯·ç¼–è¾‘é…ç½®æ–‡ä»¶: /etc/ttbox/config.toml"
        fi
        
        if [ ! -f /etc/ttbox/.env ]; then
            cp .env /etc/ttbox/.env
            echo "âš™ï¸  è¯·ç¼–è¾‘çŽ¯å¢ƒå˜é‡: /etc/ttbox/.env"
        fi
        
        # åˆ›å»º systemd æœåŠ¡
        cat > /etc/systemd/system/ttbox_salvo.service << 'SERVICE'
        [Unit]
        Description=TTBox Salvo Application
        After=network.target mysql.service
        
        [Service]
        Type=simple
        User=ttbox
        Group=ttbox
        WorkingDirectory=/opt/ttbox
        ExecStart=/opt/ttbox/ttbox_salvo
        Restart=always
        RestartSec=10
        Environment="RUST_LOG=info"
        
        # å®‰å…¨è®¾ç½®
        NoNewPrivileges=true
        PrivateTmp=true
        ProtectSystem=strict
        ProtectHome=true
        ReadWritePaths=/opt/ttbox /var/log/ttbox
        
        [Install]
        WantedBy=multi-user.target
        SERVICE
        
        systemctl daemon-reload
        systemctl enable ttbox_salvo
        
        echo "âœ… éƒ¨ç½²å®Œæˆ!"
        echo ""
        echo "ä¸‹ä¸€æ­¥æ“ä½œ:"
        echo "1. ç¼–è¾‘é…ç½®æ–‡ä»¶: sudo nano /etc/ttbox/config.toml"
        echo "2. ç¼–è¾‘çŽ¯å¢ƒå˜é‡: sudo nano /etc/ttbox/.env"
        echo "3. å¯åŠ¨æœåŠ¡: sudo systemctl start ttbox_salvo"
        echo "4. æŸ¥çœ‹æ—¥å¿—: sudo journalctl -u ttbox_salvo -f"
        EOF
        
        chmod +x release/deploy.sh
        
        # æ‰“åŒ…
        tar -czf ttbox_salvo-linux.tar.gz -C release .
    
    - name: Generate version number
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${{ github.ref_name }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        else
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          
          if [[ $LATEST_TAG =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            PATCH=${BASH_REMATCH[3]}
            PATCH=$((PATCH + 1))
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          else
            NEW_VERSION="v0.0.1"
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $NEW_VERSION"
        fi
    
    - name: Create and push tag for main branch
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        if git rev-parse "$VERSION" >/dev/null 2>&1; then
          echo "Tag $VERSION already exists, skipping tag creation"
        else
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"
          echo "Created and pushed tag: $VERSION"
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ttbox_salvo-linux-${{ github.run_number }}
        path: ttbox_salvo-linux.tar.gz
        retention-days: 30
        compression-level: 6
    
    - name: Create Release
      if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
      uses: softprops/action-gh-release@v1
      with:
        files: ttbox_salvo-linux.tar.gz
        draft: false
        prerelease: false
        generate_release_notes: true
        tag_name: ${{ steps.version.outputs.version }}
        name: TTBox Salvo ${{ steps.version.outputs.version }}
        body: |
          ## ðŸš€ è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ ${{ steps.version.outputs.version }}
          
          è¿™æ˜¯è‡ªåŠ¨åˆ›å»ºçš„æœ€æ–°ç‰ˆæœ¬ï¼ŒåŒ…å«äº†æœ€æ–°çš„ä»£ç æ›´æ”¹ã€‚
          
          ### ðŸ“¦ ä¸‹è½½å’Œå®‰è£…
          
          ### ä¸‹è½½æ–‡ä»¶
          - `ttbox_salvo-linux.tar.gz` - Linux å‘å¸ƒåŒ…
          
          ### éƒ¨ç½²æ–¹æ³•
          ```bash
          # 1. ä¸Šä¼ åˆ°æœåŠ¡å™¨
          scp ttbox_salvo-linux.tar.gz user@server:/tmp/
          
          # 2. è§£åŽ‹
          tar -xzf ttbox_salvo-linux.tar.gz
          
          # 3. è¿è¡Œéƒ¨ç½²è„šæœ¬
          sudo ./deploy.sh
          ```
          
          ### è¯¦ç»†æ–‡æ¡£
          è¯·æŸ¥çœ‹ [GITHUB_WORKFLOW.md](https://github.com/${{ github.repository }}/blob/main/GITHUB_WORKFLOW.md) äº†è§£æ›´å¤šéƒ¨ç½²ä¿¡æ¯ã€‚
          
          ---
          
          **æ³¨æ„**: æ­¤ç‰ˆæœ¬ç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºã€‚
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update latest tag
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git push origin :refs/tags/latest 2>/dev/null || true
        git tag -d latest 2>/dev/null || true
        
        git tag -a latest -m "Latest release"
        git push origin latest
        echo "Updated latest tag"
    
    - name: Upload to Artifacts (for main branch)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: ttbox_salvo-linux
        path: ttbox_salvo-linux.tar.gz
        retention-days: 30
        compression-level: 6
